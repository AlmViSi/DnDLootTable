<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D 3.5 Распределение добычи</title>
    <link href="https://fonts.googleapis.com/css2?family=Balthazar&display=swap" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <button class="refresh-btn" id="refreshData">↻</button>
        
        <div class="content-wrapper">
            <div class="content-area">
                <div class="unassigned-column">
                    <div class="unassigned-header">
                        <div class="unassigned-title">Не распределено</div>
                    </div>
                    <div class="unassigned-items" id="unassignedItems"></div>
                    <div class="character-total">Всего: <span id="unassignedTotal">0 зол.</span></div>
                    
                    <div class="buttons-row">
                        <button class="add-button" id="addCharacterBtn">+ Персонаж</button>
                        <button class="add-button" id="addItemBtn">+ Предмет</button>
                    </div>
                </div>
                
                <div class="characters-container" id="charactersContainer">
                    <!-- Персонажи будут добавлены здесь через JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="total-section">
            <div class="total-box">
                <div>Всего золота</div>
                <div class="total-value" id="globalGoldTotal">0 зол.</div>
            </div>
            <div class="total-box">
                <div>Всего предметов</div>
                <div class="total-value" id="globalItemsTotal">0</div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для редактирования предмета -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-title">Редактировать предмет</div>
            <input type="text" id="editItemName" placeholder="Название предмета" class="modal-input">
            <textarea id="editItemDescription" placeholder="Описание предмета" class="modal-textarea"></textarea>
            <div class="modal-buttons">
                <button class="modal-button" id="cancelEdit">Отмена</button>
                <button class="modal-button" id="saveEdit">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для добавления персонажа -->
    <div class="modal" id="characterModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-title">Добавить персонажа</div>
            <input type="text" id="characterName" placeholder="Имя персонажа" class="modal-input" required>
            <input type="text" id="characterNickname" placeholder="Прозвище (опционально)" class="modal-input">
            <input type="text" id="characterImage" placeholder="URL изображения (опционально)" class="modal-input">
            <div class="modal-buttons">
                <button class="modal-button" id="saveCharacter">Сохранить</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для добавления предметов -->
    <div class="modal" id="itemsModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-title">Добавить предметы</div>
            <p>Формат: Название | Цена (gp) | Слот | Описание (опционально)</p>
            <p>Пример: <em>Меч света | 1500 | Weapon | Светится в темноте</em></p>
            <textarea id="itemsTextarea" class="modal-textarea" placeholder="Введите предметы, каждый с новой строки"></textarea>
            <div class="modal-buttons">
                <button class="modal-button" id="saveItems">Добавить предметы</button>
            </div>
        </div>
    </div>

    <div class="scroll-indicator" id="scrollToTop">↑</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const charactersContainer = document.getElementById('charactersContainer');
            const unassignedItemsContainer = document.getElementById('unassignedItems');
            const scrollToTopBtn = document.getElementById('scrollToTop');
            const editModal = document.getElementById('editModal');
            const editItemName = document.getElementById('editItemName');
            const editItemDescription = document.getElementById('editItemDescription');
            const cancelEditBtn = document.getElementById('cancelEdit');
            const saveEditBtn = document.getElementById('saveEdit');
            const refreshDataBtn = document.getElementById('refreshData');
            const addCharacterBtn = document.getElementById('addCharacterBtn');
            const addItemBtn = document.getElementById('addItemBtn');
            const characterModal = document.getElementById('characterModal');
            const itemsModal = document.getElementById('itemsModal');
            const saveCharacterBtn = document.getElementById('saveCharacter');
            const saveItemsBtn = document.getElementById('saveItems');
            const itemsTextarea = document.getElementById('itemsTextarea');
            const closeButtons = document.querySelectorAll('.close');
            
            // Текущий редактируемый предмет
            let currentEditingItem = null;
            
            // Static slot icons configuration
            const slotIcons = {
                'Armor': 'https://i.ibb.co/Wv6zmFST/Armor-pixian-ai.png',
                'Arms': 'https://i.ibb.co/mrSzqfQv/Arms-pixian-ai.png',
                'Body': 'https://i.ibb.co/GQZgcfyW/Body-pixian-ai.png',
                'Face': 'https://i.ibb.co/8gDnTsfT/Face-pixian-ai.png',
                'Feet': 'https://i.ibb.co/nqDJxwZW/Feets-pixian-ai.png',
                'Hands': 'https://i.ibb.co/gb27yx9S/Hands-pixian-ai.png',
                'Head': 'https://i.ibb.co/b51WW4QR/Head-pixian-ai.png',
                'Misc': 'https://i.ibb.co/ks4jh5C9/Misc-pixian-ai.png',
                'Other': 'https://i.ibb.co/YBGy1bYC/Other-pixian-ai.png',
                'Ring': 'https://i.ibb.co/HLScw4bm/Ring-pixian-ai.png',
                'Shoulder': 'https://i.ibb.co/35DJcS2q/Cloak-pixian-ai.png',
                'Throat': 'https://i.ibb.co/KcpSR01R/Throat-pixian-ai.png',
                'Torso': 'https://i.ibb.co/HDtWYCHm/Torso-pixian-ai.png',
                'Tools': 'https://i.ibb.co/Rp826FvD/Tools-pixian-ai.png',
                'Waist': 'https://i.ibb.co/whxjqPLK/Waist-pixian-ai.png',
                'Weapon': 'https://i.ibb.co/FLyv7J4P/Weapons-pixian-ai.png'
            };
            
            // Slot configuration with icons
            const slotConfig = [
                { key: 'Head', name: 'Голова', icon: slotIcons.Head },
                { key: 'Face', name: 'Лицо', icon: slotIcons.Face },
                { key: 'Throat', name: 'Шея', icon: slotIcons.Throat },
                { key: 'Shoulder', name: 'Плечи', icon: slotIcons.Shoulder },
                { key: 'Armor', name: 'Доспех', icon: slotIcons.Armor },
                { key: 'Weapon', name: 'Оружие', icon: slotIcons.Weapon },
                { key: 'Body', name: 'Тело', icon: slotIcons.Body },
                { key: 'Torso', name: 'Торс', icon: slotIcons.Torso },
                { key: 'Arms', name: 'Руки', icon: slotIcons.Arms },
                { key: 'Hands', name: 'Перчатки', icon: slotIcons.Hands },
                { key: 'Feet', name: 'Ноги', icon: slotIcons.Feet },
                { key: 'Waist', name: 'Пояс', icon: slotIcons.Waist },
                { key: 'Ring', name: 'Кольцо', icon: slotIcons.Ring },
                { key: 'Tools', name: 'Инструменты', icon: slotIcons.Tools },
                { key: 'Other', name: 'Другое', icon: slotIcons.Other },
                { key: 'Misc', name: 'Разное', icon: slotIcons.Misc }
            ];
            
            // Initialize with empty state
            initializeApp();
            
            // Initialize app with sample data
            function initializeApp() {
                // Add sample character
                addCharacter('Пример Персонажа', 'Прозвище', '');
                
                // Add sample items
                const sampleItems = [
                    'Меч света | 1500 | Weapon | Светится в темноте',
                    'Кольцо защиты | 2000 | Ring | +1 к защите',
                    'Нагрудник дракона | 3500 | Armor | Из чешуи красного дракона'
                ];
                
                sampleItems.forEach(item => {
                    const parts = item.split('|').map(part => part.trim());
                    if (parts.length >= 3) {
                        addItemToContainer(
                            parts[0],
                            1,
                            parseFloat(parts[1]) || 0,
                            parts[2],
                            unassignedItemsContainer,
                            false,
                            parts[3] || ''
                        );
                    }
                });
                
                updateTotals();
            }
            
            // Refresh data button
            refreshDataBtn.addEventListener('click', function() {
                // Clear existing data
                charactersContainer.innerHTML = '';
                unassignedItemsContainer.innerHTML = '';
                
                // Reinitialize with sample data
                initializeApp();
            });
            
            // Edit item modal
            function showEditModal(item) {
                currentEditingItem = item;
                editItemName.value = item.querySelector('.item-name').textContent;
                editItemDescription.value = item.dataset.description || '';
                editModal.style.display = 'flex';
                editItemName.focus();
            }
            
            function hideEditModal() {
                editModal.style.display = 'none';
                currentEditingItem = null;
            }
            
            // Save edited item
            saveEditBtn.addEventListener('click', function() {
                if (currentEditingItem) {
                    currentEditingItem.querySelector('.item-name').textContent = editItemName.value;
                    currentEditingItem.dataset.description = editItemDescription.value;
                    
                    const descElement = currentEditingItem.querySelector('.item-description');
                    if (descElement) {
                        descElement.textContent = editItemDescription.value;
                    } else if (editItemDescription.value) {
                        const newDescElement = document.createElement('div');
                        newDescElement.className = 'item-description';
                        newDescElement.textContent = editItemDescription.value;
                        currentEditingItem.appendChild(newDescElement);
                    }
                    
                    hideEditModal();
                }
            });
            
            cancelEditBtn.addEventListener('click', hideEditModal);
            
            // Close modal when clicking outside
            editModal.addEventListener('click', function(e) {
                if (e.target === editModal) {
                    hideEditModal();
                }
            });
            
            // Character modal
            addCharacterBtn.addEventListener('click', function() {
                characterModal.style.display = 'flex';
                document.getElementById('characterName').focus();
            });
            
            // Items modal
            addItemBtn.addEventListener('click', function() {
                itemsModal.style.display = 'flex';
                itemsTextarea.focus();
            });
            
            // Close buttons
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            // Save character
            saveCharacterBtn.addEventListener('click', function() {
                const name = document.getElementById('characterName').value;
                const nickname = document.getElementById('characterNickname').value;
                const imageUrl = document.getElementById('characterImage').value;
                
                if (name) {
                    addCharacter(name, nickname, imageUrl);
                    characterModal.style.display = 'none';
                    
                    // Clear fields
                    document.getElementById('characterName').value = '';
                    document.getElementById('characterNickname').value = '';
                    document.getElementById('characterImage').value = '';
                } else {
                    alert('Пожалуйста, введите имя персонажа');
                }
            });
            
            // Save items
            saveItemsBtn.addEventListener('click', function() {
                const itemsText = itemsTextarea.value;
                const lines = itemsText.split('\n').filter(line => line.trim());
                
                lines.forEach(line => {
                    const parts = line.split('|').map(part => part.trim());
                    if (parts.length >= 3) {
                        const name = parts[0];
                        const value = parseFloat(parts[1]) || 0;
                        const slot = parts[2];
                        const description = parts[3] || '';
                        
                        addItemToContainer(
                            name,
                            1,
                            value,
                            slot,
                            unassignedItemsContainer,
                            false,
                            description
                        );
                    }
                });
                
                itemsModal.style.display = 'none';
                itemsTextarea.value = '';
                updateTotals();
            });
            
            // Scroll to top button
            scrollToTopBtn.addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // Add character function
            function addCharacter(name, nickname = '', imageUrl = '') {
                const characterId = 'character-' + Date.now();
                const character = document.createElement('div');
                character.className = 'character';
                character.id = characterId;
                
                // Create background element if image URL provided
                if (imageUrl) {
                    const bg = document.createElement('div');
                    bg.className = 'character-background';
                    bg.style.backgroundImage = `url('${imageUrl}')`;
                    character.appendChild(bg);
                }
                
                // Create content container
                const content = document.createElement('div');
                content.className = 'character-content';
                
                // Generate slots HTML with icons
                let slotsHTML = '';
                slotConfig.forEach(slot => {
                    const iconHTML = slot.icon ? `<img src="${slot.icon}" alt="${slot.name}" onerror="this.style.display='none'">` : '';
                    slotsHTML += `
                        <div class="slot-group">
                            <div class="slot-label">${iconHTML}${slot.name}</div>
                            <div class="slot" data-slot="${slot.key}" id="${characterId}-${slot.key}"></div>
                        </div>
                    `;
                });
                
                content.innerHTML = `
                    <div class="character-header">
                        <div class="character-title-row">
                            <div class="character-title">${name}</div>
                            <div class="delete-character" data-character="${characterId}">✕</div>
                        </div>
                        <div class="character-nickname" contenteditable="true">${nickname}</div>
                        <div class="character-total-header">Всего: <span id="${characterId}-total-header">0 зол.</span></div>
                    </div>
                    <div class="character-slots">
                        ${slotsHTML}
                    </div>
                `;
                
                character.appendChild(content);
                charactersContainer.appendChild(character);
                
                // Add delete character functionality
                character.querySelector('.delete-character').addEventListener('click', function() {
                    character.querySelectorAll('.item').forEach(item => {
                        unassignedItemsContainer.appendChild(item);
                    });
                    character.remove();
                    updateTotals();
                });
                
                // Setup drag and drop for slots
                character.querySelectorAll('.slot').forEach(slot => {
                    setupDropTarget(slot);
                });
                
                // Setup drop for entire character
                setupCharacterDropTarget(character);
                
                return character;
            }
            
            // Add item to container function
            function addItemToContainer(name, qty, value, slot, container, isGold = false, description = '') {
                const itemId = 'item-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
                const item = document.createElement('div');
                item.className = 'item';
                item.id = itemId;
                item.draggable = true;
                item.dataset.value = value;
                item.dataset.isGold = isGold;
                item.dataset.slot = slot;
                item.dataset.description = description;
                
                // Проверяем, является ли контейнер слотом персонажа
                const isCharacterSlot = container.classList.contains('slot');
                
                // Для предметов в инвентаре персонажа вообще не добавляем иконку
                const iconHTML = !isCharacterSlot ? 
                    `<img src="${slotIcons[slot] || slotIcons.Other}" class="item-icon" alt="${slot}" onerror="this.style.display='none'">` : 
                    '';
                
                let descriptionHTML = '';
                if (description) {
                    descriptionHTML = `<div class="item-description">${description}</div>`;
                }
                
                item.innerHTML = `
                    <div class="item-content">
                        ${iconHTML}
                        <div class="item-text">
                            <div class="item-name">${name}</div>
                            <div class="item-details">
                                <span>${value} зол.</span>
                                ${isGold ? '<span>💰</span>' : ''}
                            </div>
                            ${descriptionHTML}
                        </div>
                    </div>
                    <div class="item-actions">
                        <div class="edit-item" data-item="${itemId}">✎</div>
                        <div class="delete-item" data-item="${itemId}">✕</div>
                    </div>
                `;
                
                container.appendChild(item);
                
                // Если это слот персонажа, показываем группу слотов
                if (isCharacterSlot) {
                    const slotGroup = container.closest('.slot-group');
                    if (slotGroup) {
                        slotGroup.classList.add('has-items');
                    }
                }
                
                // Add delete item functionality
                item.querySelector('.delete-item').addEventListener('click', function(e) {
                    e.stopPropagation();
                    item.remove();
                    updateTotals();
                });
                
                // Add edit item functionality
                item.querySelector('.edit-item').addEventListener('click', function(e) {
                    e.stopPropagation();
                    showEditModal(item);
                });
                
                // Setup drag and drop
                setupDraggableItem(item);
                
                return item;
            }
            
            // Setup draggable item
            function setupDraggableItem(item) {
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', item.id);
                    setTimeout(() => {
                        item.classList.add('item-dragging');
                    }, 0);
                });
                
                item.addEventListener('dragend', function() {
                    this.classList.remove('item-dragging');
                    document.querySelectorAll('.slot-highlight').forEach(el => {
                        el.classList.remove('slot-highlight');
                    });
                });
            }
            
            // Setup drop target
            function setupDropTarget(slot) {
                slot.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('slot-highlight');
                });
                
                slot.addEventListener('dragleave', function() {
                    this.classList.remove('slot-highlight');
                });
                
                slot.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('slot-highlight');
                    const itemId = e.dataTransfer.getData('text/plain');
                    const item = document.getElementById(itemId);
                    
                    if (item) {
                        const targetSlot = this.dataset.slot;
                        const itemSlot = item.dataset.slot;
                        
                        if (targetSlot === itemSlot || targetSlot === 'Other') {
                            item.remove();
                            this.appendChild(item);
                            updateTotals();
                        }
                    }
                });
            }
            
            // Auto-place items when dropped on character (not specific slot)
            function setupCharacterDropTarget(character) {
                character.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                character.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const itemId = e.dataTransfer.getData('text/plain');
                    const item = document.getElementById(itemId);
                    
                    if (item) {
                        const slotType = item.dataset.slot;
                        const slot = character.querySelector(`.slot[data-slot="${slotType}"]`) || 
                                     character.querySelector('.slot[data-slot="Other"]');
                        
                        if (slot) {
                            item.remove();
                            slot.appendChild(item);
                            updateTotals();
                        }
                    }
                });
            }
            
            // Setup drop for unassigned items
            setupDropTarget(unassignedItemsContainer);
            
            // Allow dropping items back to unassigned from characters
            unassignedItemsContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('slot-highlight');
            });
            
            unassignedItemsContainer.addEventListener('dragleave', function() {
                this.classList.remove('slot-highlight');
            });
            
            unassignedItemsContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('slot-highlight');
                const itemId = e.dataTransfer.getData('text/plain');
                const item = document.getElementById(itemId);
                
                if (item) {
                    item.remove();
                    this.appendChild(item);
                    updateTotals();
                }
            });
            
            // Update all totals
            function updateTotals() {
                // Сначала скрываем все группы слотов
                document.querySelectorAll('.slot-group').forEach(group => {
                    group.classList.remove('has-items');
                });
                
                // Затем показываем только те, где есть предметы
                document.querySelectorAll('.slot .item').forEach(item => {
                    const slotGroup = item.closest('.slot-group');
                    if (slotGroup) {
                        slotGroup.classList.add('has-items');
                    }
                });
                
                // Update each character's total
                document.querySelectorAll('.character').forEach(character => {
                    let totalValue = 0;
                    
                    character.querySelectorAll('.slot .item').forEach(item => {
                        totalValue += parseFloat(item.dataset.value) || 0;
                    });
                    
                    const totalElement = character.querySelector('.character-total-header span');
                    if (totalElement) {
                        totalElement.textContent = `${totalValue.toFixed(2)} зол.`;
                    }
                });
                
                // Update unassigned total
                let unassignedValue = 0;
                document.querySelectorAll('#unassignedItems .item').forEach(item => {
                    unassignedValue += parseFloat(item.dataset.value) || 0;
                });
                document.getElementById('unassignedTotal').textContent = `${unassignedValue.toFixed(2)} зол.`;
                
                // Update global totals
                let globalGold = 0;
                let globalItems = 0;
                
                document.querySelectorAll('.item').forEach(item => {
                    globalGold += parseFloat(item.dataset.value) || 0;
                    globalItems++;
                });
                
                document.getElementById('globalGoldTotal').textContent = `${globalGold.toFixed(2)} зол.`;
                document.getElementById('globalItemsTotal').textContent = globalItems;
            }
        });
    </script>
</body>
</html>
